<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'nonce-figo123'; base-uri 'none'; form-action 'self'; frame-ancestors 'none'">
<title>FIGO – Gestión de Negocio (v3.2)</title>
<style>
  :root{
    --bg:#f5f6f8;--card:#fff;--text:#111827;--muted:#6b7280;--brand:#0f172a;--border:#e5e7eb;--danger:#b91c1c;--ok:#15803d;--shadow:0 10px 24px rgba(0,0,0,.08);
    --pink-head:#f4c3d4; --pink-row:#ffe3ef; --pink-active:#e2628f; --pink-strong:#f6a6bf;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans","Liberation Sans",sans-serif;background:var(--bg);color:var(--text)}
  .container{max-width:1180px;margin:0 auto;padding:24px 16px 64px}
  header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:16px}
  .brand{display:flex;align-items:center;gap:12px}
  .avatar{width:40px;height:40px;border-radius:50%;overflow:hidden;background:#111827;display:grid;place-items:center;font-weight:800;color:#fff;cursor:pointer}
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .title{font-size:18px;font-weight:800}
  .subtitle{font-size:12px;color:var(--muted)}
  .btns{display:flex;gap:12px}
  .btn{appearance:none;border:none;border-radius:14px;padding:12px 18px;font-weight:700;background:#111827;color:#fff;cursor:pointer;box-shadow:var(--shadow)}
  .btn.secondary{background:#fff;color:#0f172a;border:1px solid var(--border)}
  .btn.light{background:#fff;color:#111827;border:1px solid var(--border)}
  .btn.ok{background:#15803d}
  .btn.sm{padding:6px 10px;font-size:12px;border-radius:10px}
  nav{background:#fff;border:1px solid var(--border);border-radius:18px;padding:10px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;box-shadow:var(--shadow);position:sticky;top:0;z-index:3}
  .pill{padding:9px 14px;border-radius:999px;border:1px solid var(--border);background:#fff;color:#111827;font-weight:700;cursor:pointer}
  .pill.active{background:var(--pink-active);color:#fff;border-color:var(--pink-active)}
  .search{margin-left:auto}
  .search input{width:320px;max-width:50vw;padding:10px 14px;border-radius:12px;border:1px solid var(--border);outline:none}
  .tabs{margin-top:16px}.tab{display:none}.tab.active{display:block}
  .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
  .muted{color:var(--muted)}
  .tablewrap{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:12px}
  .toolbar{display:flex;align-items:center;gap:12px;margin-bottom:8px;flex-wrap:wrap}
  .toolbar .grow{margin-left:auto}
  .tbl{width:100%;border-collapse:separate;border-spacing:0}
  .tbl thead th{position:sticky;top:0;background:var(--pink-head)!important;z-index:1;text-align:left;font-size:12px;color:#111827;border-bottom:1px solid var(--border);padding:10px 10px;font-weight:800}
  .tbl tbody td{border-bottom:1px solid var(--border);padding:8px 10px;font-size:13px;vertical-align:top}
  .tbl tbody tr:nth-child(odd){background:#ffffff!important}
  .tbl tbody tr:nth-child(even){background:var(--pink-row)!important}
  .tbl tbody tr:hover{background:#fbd2e3!important}
  .tfoot{display:flex;align-items:center;justify-content:flex-end;gap:10px;margin-top:8px;padding:10px;border-top:1px solid var(--border)}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#f8fafc;font-size:12px}
  .fee{font-weight:800}
  .fee.red{color:var(--danger)}
  .fee.green{color:var(--ok);border:1px solid #bbf7d0;background:#e8fff1;border-radius:999px;padding:4px 8px}
  .grouprow td{background:var(--pink-strong)!important;font-weight:800;border-top:1px solid var(--border)}
  .linkbtn{background:none;border:none;color:#c02652;cursor:pointer;padding:0;font-weight:800}
  .linkbtn:hover{text-decoration:underline}
  .row-highlight{animation:flash 4s ease-out 1}
  @keyframes flash{0%{box-shadow:inset 0 0 0 9999px rgba(226,98,144,.35)}100%{box-shadow:inset 0 0 0 0 rgba(226,98,144,0)}}
  dialog::backdrop{background:rgba(0,0,0,.35)} dialog{width:min(980px,92vw);border:none;border-radius:22px;padding:0;box-shadow:var(--shadow)}
  .modal-header{position:sticky;top:0;background:#fff;z-index:2;display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid var(--border)}
  .modal-content{padding:18px 22px;max-height:78vh;overflow:auto}
  .section-title{font-size:12px;font-weight:800;color:#6b7280;letter-spacing:.04em;margin:20px 0 10px}
  form{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
  label{font-size:13px;font-weight:700;color:#111827;display:block;margin-bottom:6px}
  input[type="text"],input[type="email"],input[type="tel"],input[type="number"],input[type="password"],input[type="file"],select,textarea{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--border);outline:none;background:#fff}
  textarea{resize:vertical;min-height:38px}
  .span-2{grid-column:span 2}.span-3{grid-column:span 3}
  .summary{background:#f8fafc;border:1px solid var(--border);border-radius:14px;padding:14px}
  .box{background:#fff;border:1px solid var(--border);border-radius:16px;padding:14px;text-align:center}
  .box strong{font-size:18px}
  .modal-footer{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--border);padding:16px 22px;display:flex;justify-content:flex-end;gap:12px}
  .total-chip{background:#e8fff1;border:1px solid #bbf7d0;color:#065f46;border-radius:999px;padding:10px 14px;font-weight:800;margin-right:auto;display:inline-flex;align-items:center;gap:8px}
  .required::after{content:" *";color:var(--danger);font-weight:800}
  .hidden{display:none!important}
  #btnStats{display:none!important;}
  .talle-chip{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:800;border:1px solid var(--border);font-size:12px}
  .talle-XP,.talle-Todos,.talle-ALL{background:var(--pink-row)} .talle-P{background:#d7f0ff}.talle-M{background:#e6ffd7}.talle-G{background:#fff3d7}.talle-XG{background:#e7d7ff}.talle-2XG{background:#ffd7f0}.talle-3XG{background:#d7fff7}
  #tab-corte .tbl th,#tab-corte .tbl td,#tab-bordado .tbl th,#tab-bordado .tbl td,#tab-confeccion .tbl th,#tab-confeccion .tbl td{text-align:center}
  .talle-select{border-radius:12px;padding:6px 10px}
  .byline{font-size:11px;color:var(--muted);margin-top:2px}

  /* Colores dinámicos para Corte (según género) */
  #tab-corte.gender-masculino{ --pink-head:#cfe8ff; --pink-row:#eaf6ff; --pink-strong:#b7dbff; --pink-active:#60a5fa; }
  #tab-corte.gender-femenino{ --pink-head:#f4c3d4; --pink-row:#ffe3ef; --pink-strong:#f6a6bf; --pink-active:#e2628f; }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="brand">
      <div class="avatar" id="avatar">
        <img id="avatarImg" src="figo-logo.png" alt="FIGO" onerror="this.remove(); this.parentElement.textContent='F'">
      </div>
      <input id="avatarFile" type="file" accept=".png,.jpg,.jpeg" class="hidden">
      <div>
        <div class="title">FIGO – Gestión de Negocio <span class="muted">(v3.2 · local)</span></div>
        <div class="subtitle">Sin servidor · datos guardados en tu navegador</div>
      </div>
    </div>
    <div class="btns">
      <button class="btn light" id="btnNuevoPedido">Nuevo Pedido</button>
      <button class="btn" id="btnNuevaVenta">Nueva Venta</button>
      <button class="btn secondary" id="btnNuevoItem">Nuevo ítem</button>
      <button class="btn light" id="btnLogout">Cerrar sesión</button>
    </div>
  </header>

  <nav id="tabsNav">
    <button class="pill active" data-tab="pedidos">Pedidos</button>
    <button class="pill" data-tab="inventario">Inventario</button>
    <button class="pill" data-tab="corte">Corte</button>
    <button class="pill" data-tab="bordado">Bordado</button>
    <button class="pill" data-tab="confeccion">Confección</button>
    <button class="pill" data-tab="listos">Pedidos Listos</button>
    <button class="pill" data-tab="falta">Falta abonar</button>
    <button class="pill" data-tab="ventas">Ventas</button>
    <button class="pill pill-admin" data-tab="stats">Estadísticas</button>
    <button class="pill pill-admin" data-tab="config">Config</button>
    <div class="search">
      <input type="text" id="searchBox" placeholder="Buscar por nombre/teléfono/código/RUC/RS/email">
    </div>
  </nav>

  <div class="tabs">
    <!-- PEDIDOS -->
    <section class="tab active" id="tab-pedidos">
      <div class="tablewrap">
        <div class="toolbar">
          <b>Pedidos (resumen)</b>
          <div class="grow"></div>
          <span class="muted">Click en “Ver detalle”.</span>
        </div>
        <div style="max-height:60vh;overflow:auto;border:1px solid var(--border);border-radius:10px" id="pedidosScroll">
          <table class="tbl" id="tbl-pedidos">
            <thead>
              <tr>
                <th>#</th><th>Fecha</th><th>Cliente</th><th>Teléfono</th>
                <th>Razón Social</th><th>RUC</th>
                <th>Etapa</th><th>Seña</th><th>Total</th><th>Saldo</th><th>Detalle</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- INVENTARIO -->
    <section class="tab" id="tab-inventario">
      <div class="tablewrap">
        <div class="toolbar">
          <b>Inventario</b>
          <div style="display:flex;gap:8px;margin-left:16px;flex-wrap:wrap">
            <label style="display:flex;align-items:center;gap:6px">Género
              <select id="invFilterGen">
                <option>Todos</option><option>Femenino</option><option>Masculino</option>
              </select>
            </label>
            <label style="display:flex;align-items:center;gap:6px">Talle
              <select id="invFilterTalle">
                <option>Todos</option><option>XP</option><option>P</option><option>M</option><option>G</option><option>XG</option><option>2XG</option><option>3XG</option>
              </select>
            </label>
            <label style="display:flex;align-items:center;gap:6px">Organización
              <select id="invGroupMode">
                <option>Conjunto</option><option>Prenda</option>
              </select>
            </label>
          </div>
          <div class="grow"></div>
          <span id="invSum" class="muted"></span>
        </div>
        <div style="max-height:60vh;overflow:auto;border:1px solid var(--border);border-radius:10px">
          <table class="tbl" id="tbl-inv">
            <thead>
              <tr>
                <th>#</th><th>Género</th><th>Categoría</th><th>Tela</th><th>Color</th><th>Talle</th><th>Stock</th><th>Precio (prenda)</th><th>Descripción</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CORTE -->
    <section class="tab" id="tab-corte">
      <div class="tablewrap">
        <div class="toolbar">
          <div><b>Filtrar por talle</b>:
            <select id="corteFilter"><option value="Todos">Todos</option></select>
          </div>
          <div><b>Género</b>:
            <select id="corteGender"><option>Todos</option><option>Femenino</option><option>Masculino</option></select>
          </div>
          <div class="grow"></div>
          <div id="corteCount" class="muted">Recibidos seleccionados: 0</div>
        </div>
        <div style="max-height:55vh;overflow:auto;border:1px solid var(--border);border-radius:10px">
          <table class="tbl" id="tbl-corte">
            <thead>
              <tr>
                <th>#</th><th>Tel (últ. 3)</th><th>Género</th><th>Tela</th><th>Color</th>
                <th>Chomba</th><th>Modelo</th><th>Pantalón</th>
                <th>Bord. Nombre</th><th>Bord. Logo</th><th>Otras especificaciones</th>
                <th>Recibido / Cargo</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="tfoot">
          <strong class="fee red">Falta abonar: <span id="corteExtraPend">Gs. 0</span></strong>
          <button class="btn ok" id="btnCortePagar">Pagado</button>
          <button class="btn light" id="btnCorteToNext">→ Siguiente etapa</button>
        </div>
      </div>
    </section>

    <!-- BORDADO -->
    <section class="tab" id="tab-bordado">
      <div class="tablewrap">
        <div class="toolbar">
          <div><b>Filtrar por talle</b>:
            <select id="bordadoFilter"><option value="Todos">Todos</option></select>
          </div>
          <div class="grow"></div>
          <div id="bordadoCount" class="muted">Recibidos seleccionados: 0</div>
        </div>
        <div style="max-height:55vh;overflow:auto;border:1px solid var(--border);border-radius:10px">
          <table class="tbl" id="tbl-bordado">
            <thead>
              <tr>
                <th>#</th><th>Tel (últ. 3)</th><th>Género</th><th>Tela</th><th>Color</th>
                <th>Chomba</th><th>Modelo</th>
                <th>Bord. Nombre (texto)</th><th>Letra y color</th>
                <th>Logo</th>
                <th>Otras especificaciones</th>
                <th>Recibido / Cargo</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="tfoot">
          <strong class="fee red">Falta abonar: <span id="bordadoExtraPend">Gs. 0</span></strong>
          <button class="btn ok" id="btnBordadoPagar">Pagado</button>
          <button class="btn light" id="btnBordadoToNext">→ Siguiente etapa</button>
        </div>
      </div>
    </section>

    <!-- CONFECCIÓN -->
    <section class="tab" id="tab-confeccion">
      <div class="tablewrap">
        <div class="toolbar">
          <div><b>Filtrar por talle</b>:
            <select id="confFilter"><option value="Todos">Todos</option></select>
          </div>
        </div>
        <div style="max-height:55vh;overflow:auto;border:1px solid var(--border);border-radius:10px">
          <table class="tbl" id="tbl-conf">
            <thead>
              <tr>
                <th>#</th><th>Tel (últ. 3)</th><th>Género</th><th>Tela</th><th>Color</th>
                <th>Chomba</th><th>Modelo</th><th>Pantalón</th>
                <th>Bord. Nombre</th><th>Bord. Logo</th><th>Otras especificaciones</th>
                <th>Confección OK / Cargo</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="tfoot">
          <strong class="fee red">Falta abonar: <span id="confExtraPend">Gs. 0</span></strong>
          <button class="btn ok" id="btnConfPagar">Pagado</button>
          <button class="btn light" id="btnConfToNext">→ Siguiente etapa</button>
        </div>
      </div>
    </section>

    <!-- LISTOS -->
    <section class="tab" id="tab-listos">
      <div class="tablewrap">
        <div class="toolbar">
          <b>Pedidos Listos</b>
          <div class="grow"></div>
          <span class="muted">Saldo y “Pago al recibir”.</span>
        </div>
        <div style="max-height:60vh;overflow:auto;border:1px solid var(--border);border-radius:10px">
          <table class="tbl" id="tbl-listos">
            <thead>
              <tr>
                <th>#</th><th>Cliente</th><th>Teléfono</th><th>Entrega (detalle)</th>
                <th>Saldo</th><th>Pago al recibir</th><th>Envío</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- FALTA ABONAR -->
    <section class="tab" id="tab-falta">
      <div class="tablewrap">
        <div class="toolbar"><b>Falta abonar</b></div>
        <div style="max-height:60vh;overflow:auto;border:1px solid var(--border);border-radius:10px">
          <table class="tbl" id="tbl-falta">
            <thead>
              <tr>
                <th>#</th><th>Cliente</th><th>Teléfono</th>
                <th>Seña</th><th>Total</th><th>Saldo</th><th>Método</th><th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- VENTAS -->
    <section class="tab" id="tab-ventas">
      <div class="tablewrap">
        <div class="toolbar">
          <b>Ventas</b>
          <label style="display:flex;align-items:center;gap:6px;margin-left:12px">Rango
            <select id="ventasRange">
              <option>Predeterminado</option><option>Hoy</option><option>Semanal</option><option>Mensual</option><option>Anual</option>
            </select>
          </label>
          <div class="grow"></div>
          <span id="ventasCount" class="muted"></span>
        </div>
        <div style="max-height:60vh;overflow:auto;border:1px solid var(--border);border-radius:10px">
          <table class="tbl" id="tbl-ventas">
            <thead>
              <tr>
                <th>#</th><th>Fecha envío</th><th>Cliente</th><th>Teléfono</th><th>Total</th><th>Pagado</th><th>Saldo</th><th>Detalle</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ESTADÍSTICAS -->
    <section class="tab" id="tab-stats">
      <div class="tablewrap">
        <div class="toolbar">
          <b>Estadísticas de pagos</b>
          <label style="display:flex;align-items:center;gap:6px;margin-left:12px">Rango
            <select id="statsRange">
              <option>Predeterminado</option><option>Hoy</option><option>Semanal</option><option>Mensual</option><option>Anual</option>
            </select>
          </label>
          <button class="btn light" id="btnStatsPDF" title="Descargar PDF del resumen actual">Descargar PDF</button>
          <div class="grow"></div>
          <span id="statsTotals" class="muted"></span>
        </div>
        <div style="max-height:60vh;overflow:auto;border:1px solid var(--border);border-radius:10px">
          <table class="tbl" id="tbl-stats">
            <thead>
              <tr>
                <th>Fecha</th><th>#</th><th>Cliente</th><th>Teléfono</th>
                <th>Método</th><th>Concepto</th><th>Monto</th>
                <th>Seña</th><th>Total</th><th>Diferencia</th><th>Saldo actual</th><th>Pagado</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="tfoot" id="statsFoot"></div>
      </div>
    </section>

    <!-- CONFIG -->
    <section class="tab" id="tab-config">
      <div class="card" style="margin-bottom:12px">
        <h3 style="margin:0 0 8px 0">Gestión de usuarios</h3>
        <div class="muted" style="margin-bottom:10px">Crear usuarios con rol <b>Administrador</b> o <b>Usuario</b>.</div>
        <form id="formUser" class="span-3" style="grid-template-columns: repeat(6, 1fr); gap:10px">
          <div style="grid-column:span 2"><label for="cu_user" class="required">Usuario</label><input id="cu_user" type="text" required></div>
          <div style="grid-column:span 2"><label for="cu_pass" class="required">Contraseña</label><input id="cu_pass" type="password" required></div>
          <div><label for="cu_role" class="required">Rol</label>
            <select id="cu_role" required><option value="" disabled selected>Seleccionar…</option><option value="admin">Administrador</option><option value="usuario">Usuario</option></select>
          </div>
          <div style="display:flex;align-items:end"><button class="btn ok" id="cu_add" type="submit">Crear usuario</button></div>
        </form>
        <div style="margin-top:14px">
          <b>Usuarios actuales</b>
          <table class="tbl" id="tbl-users" style="margin-top:6px">
            <thead><tr><th>Usuario</th><th>Rol</th><th>Acciones</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card" style="margin-bottom:12px">
        <h3 style="margin:0 0 8px 0">Historial de inventario</h3>
        <div class="toolbar">
          <label style="display:flex;align-items:center;gap:6px">Rango
            <select id="invLogRange">
              <option>Hoy</option><option>Semanal</option><option>Mensual</option><option>Anual</option>
            </select>
          </label>
        </div>
        <table class="tbl" id="tbl-invlog">
          <thead><tr><th>Fecha</th><th>Usuario</th><th>Acción</th><th>Detalle</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Reglas de precios (por prenda)</h3>
        <div>Antifluido: <b>145.000</b> · Microfibra: <b>140.000</b> · Algodón: <b>135.000</b> · Tropical: <b>150.000</b></div>
        <small class="muted">*Editables en futuras versiones.</small>
      </div>
    </section>
  </div>
</div>

<!-- LOGIN -->
<dialog id="modalLogin" aria-labelledby="lg_title">
  <div class="modal-header">
    <h2 id="lg_title">Iniciar sesión</h2>
  </div>
  <div class="modal-content">
    <form id="formLogin" autocomplete="off">
      <div class="span-3">
        <label for="lg_user">Usuario</label>
        <input id="lg_user" type="text" placeholder="Usuario" required>
      </div>
      <div class="span-3">
        <label for="lg_pass">Contraseña</label>
        <input id="lg_pass" type="password" placeholder="Contraseña" required>
      </div>
      <div class="span-3">
        <label style="display:flex;align-items:center;gap:8px">
          <input id="lg_keep" type="checkbox" checked> Mantener sesión por 24 horas
        </label>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn light" id="lg_cancel">Cancelar</button>
    <button class="btn ok" id="lg_submit">Ingresar</button>
  </div>
</dialog>

<!-- NUEVO PEDIDO -->
<dialog id="modalPedido" aria-labelledby="tituloNP">
  <div class="modal-header">
    <h2 id="tituloNP">Nuevo Pedido</h2>
    <button class="pill" id="btnCerrarModal">Cerrar</button>
  </div>
  <div class="modal-content">
    <form id="formPedido" autocomplete="off">
      <div class="section-title span-3">CLIENTE</div>
      <div><label class="required" for="np_nombre">Nombre y Apellido</label><input id="np_nombre" type="text" required></div>
      <div><label class="required" for="np_tel">Teléfono</label><input id="np_tel" type="tel" inputmode="numeric" pattern="[0-9\\s+()-]{6,}" required></div>
      <div><label for="np_email">Correo electrónico</label><input id="np_email" type="email"></div>
      <div><label for="np_rs">Razón Social</label><input id="np_rs" type="text"></div>
      <div><label for="np_ruc">RUC</label><input id="np_ruc" type="text"></div>
      <div>
        <label class="required" for="np_genero">Género</label>
        <select id="np_genero" required><option value="" selected disabled>Seleccionar…</option><option>Femenino</option><option>Masculino</option><option>Unisex</option></select>
      </div>

      <div class="section-title span-3">ESPECIFICACIONES</div>
      <div>
        <label class="required" for="np_tela">Tela</label>
        <select id="np_tela" required>
          <option value="" disabled selected>Antifluido / Microfibra / Algodón / Tropical</option>
          <option>Antifluido</option><option>Microfibra</option><option>Algodón</option><option>Tropical</option>
        </select>
      </div>
      <div><label for="np_color">Color</label><input id="np_color" type="text" placeholder="Ej: Azul Marino"></div>
      <div><label for="np_modelo">Modelo</label><input id="np_modelo" type="text" placeholder="Clásico / Solapa / Mao / V"></div>
      <div><label for="np_chomba">Chomba (talle)</label><input id="np_chomba" type="text" placeholder="XP, P, M, G, XG, 2XG, 3XG"></div>
      <div><label for="np_pantalon">Pantalón (talle)</label><input id="np_pantalon" type="text" placeholder="XP, P, M, G, XG, 2XG, 3XG"></div>
      <div><label for="np_notas">Notas</label><input id="np_notas" type="text" placeholder="Otras especificaciones"></div>

      <div class="section-title span-3">BORDADOS</div>
      <div>
        <label class="required" for="np_b_nombre">Bordado de Nombre (+15.000)</label>
        <select id="np_b_nombre" required><option>No</option><option>Sí</option></select>
      </div>
      <div id="grp_nombre_bordar" class="hidden">
        <label for="np_nombre_bordar">Nombre a bordar</label>
        <input id="np_nombre_bordar" type="text" placeholder="Ej: Dra. Guadalupe Garcete">
      </div>
      <!-- NUEVO: letra y color en Nuevo Pedido -->
      <div id="grp_letra_color" class="hidden">
        <label for="np_letra_color">Letra y color</label>
        <input id="np_letra_color" type="text" placeholder="Ej: Arial · Negro">
      </div>

      <div>
        <label class="required" for="np_b_logo">Bordado de Logo (+20.000)</label>
        <select id="np_b_logo" required><option>No</option><option>Sí</option></select>
      </div>
      <div id="grp_logo_file" class="hidden">
        <label for="np_logo_file">Adjuntar imagen (PNG/JPG)</label>
        <input id="np_logo_file" type="file" accept=".png,.jpg,.jpeg">
      </div>

      <div class="section-title span-3">RESUMEN E IMPORTES</div>
      <div class="span-2 summary">
        <strong>Resumen del pedido:</strong>
        <ul id="np_resumen_list" style="margin:8px 0 0 18px;padding:0"></ul>
        <div class="muted">Regla: Antifluido 145k · Microfibra 140k · Algodón 135k · Tropical 150k (por prenda)</div>
      </div>
      <div class="box"><div>Subtotal</div><strong id="np_subtotal">Gs. 0</strong></div>

      <div class="span-3" style="display:flex;align-items:center;gap:12px">
        <label><input id="np_use_desc" type="checkbox"> Aplicar descuento</label>
        <div id="grp_desc" class="hidden" style="display:flex;align-items:center;gap:6px">
          <label for="np_desc_pct" style="margin:0">Descuento (%)</label>
          <input id="np_desc_pct" type="number" min="0" max="100" step="1" value="0" style="width:110px">
        </div>
      </div>

      <div class="section-title span-3">PAGO Y ENTREGA</div>
      <div><label class="required" for="np_senia">Seña (Gs)</label><input id="np_senia" type="text" inputmode="numeric" value="0" required></div>
      <div><label for="np_total">Total (Gs)</label><input id="np_total" type="number" value="0" readonly></div>
      <div>
        <label class="required" for="np_pago">Método de pago</label>
        <select id="np_pago" required>
          <option value="" disabled selected>Seleccionar…</option>
          <option>Efectivo</option><option>QR</option><option>Transferencia</option>
          <option>Tarjeta crédito</option><option>Tarjeta débito</option>
        </select>
      </div>
      <div>
        <label class="required" for="np_entrega">Tipo de entrega</label>
        <select id="np_entrega" required><option>Retiro en local</option><option>Delivery</option><option>Encomienda</option></select>
      </div>
      <div id="grp_delivery" class="hidden"><label for="np_delivery_gps">Dirección / Google Maps (GPS)</label><input id="np_delivery_gps" type="text"></div>
      <div id="grp_envio_city" class="hidden"><label for="np_envio_ciudad">Ciudad</label><input id="np_envio_ciudad" type="text"></div>
      <div id="grp_envio_addr" class="hidden"><label for="np_envio_dir">Dirección</label><input id="np_envio_dir" type="text"></div>
      <div class="span-2"></div>
    </form>
  </div>
  <div class="modal-footer">
    <span class="total-chip" id="chipTotal">Total: Gs. 0</span>
    <button class="btn light" id="btnCancelarPedido">Cancelar</button>
    <button class="btn ok" id="btnGuardarPedido">Guardar pedido</button>
  </div>
</dialog>

<!-- DETALLE / MODIFICAR PEDIDO -->
<dialog id="modalDetalle">
  <div class="modal-header">
    <h2 id="md_title">Detalle de pedido</h2>
    <button class="pill" id="md_close">Cerrar</button>
  </div>
  <div class="modal-content" id="md_body" style="font-size:14px;line-height:1.4"></div>
  <div class="modal-footer">
    <button class="btn light" id="md_delete" style="display:none">Eliminar</button>
    <button class="btn light" id="md_edit">Modificar</button>
    <button class="btn ok" id="md_ok">Aceptar</button>
  </div>
</dialog>

<!-- NUEVO ÍTEM -->
<dialog id="modalItem">
  <div class="modal-header">
    <h2>Nuevo ítem (Inventario)</h2>
    <button class="pill" id="mi_close">Cerrar</button>
  </div>
  <div class="modal-content">
    <form id="formItem" autocomplete="off">
      <div class="section-title span-3">Datos del ítem</div>
      <div>
        <label class="required" for="mi_genero">Género</label>
        <select id="mi_genero" required><option value="" disabled selected>Seleccionar…</option><option>Femenino</option><option>Masculino</option></select>
      </div>
      <div>
        <label class="required" for="mi_cat">Categoría</label>
        <select id="mi_cat" required><option value="" disabled selected>Seleccionar…</option><option>Chomba</option><option>Pantalón</option><option>Guardapolvo</option></select>
      </div>
      <div>
        <label class="required" for="mi_tela">Tela</label>
        <select id="mi_tela" required><option value="" disabled selected>Seleccionar…</option><option>Antifluido</option><option>Microfibra</option><option>Algodón</option><option>Tropical</option></select>
      </div>
      <div><label class="required" for="mi_color">Color</label><input id="mi_color" type="text" required></div>
      <div>
        <label class="required" for="mi_talle">Talle</label>
        <select id="mi_talle" required>
          <option value="" disabled selected>Seleccionar…</option>
          <option>XP</option><option>P</option><option>M</option><option>G</option><option>XG</option><option>2XG</option><option>3XG</option>
        </select>
      </div>
      <div><label class="required" for="mi_stock">Stock recibido</label><input id="mi_stock" type="number" min="1" step="1" value="1" required></div>
      <div class="span-3"><label for="mi_desc">Descripción (opcional)</label><input id="mi_desc" type="text" placeholder="Notas del ítem"></div>
    </form>
  </div>
  <div class="modal-footer">
    <span class="total-chip" id="mi_price">Precio prenda: Gs. 0</span>
    <button class="btn light" id="mi_cancel">Cancelar</button>
    <button class="btn ok" id="mi_save">Guardar ítem</button>
  </div>
</dialog>

<!-- NUEVA VENTA -->
<dialog id="modalVenta">
  <div class="modal-header">
    <h2>Nueva Venta</h2>
    <button class="pill" id="mv_close">Cerrar</button>
  </div>
  <div class="modal-content">
    <form id="formVenta" autocomplete="off">
      <div class="section-title span-3">CLIENTE</div>
      <div><label class="required" for="mv_nombre">Nombre y Apellido</label><input id="mv_nombre" type="text" required></div>
      <div><label class="required" for="mv_tel">Teléfono</label><input id="mv_tel" type="tel" inputmode="numeric" pattern="[0-9\\s+()-]{6,}" required></div>
      <div><label for="mv_email">Correo electrónico</label><input id="mv_email" type="email"></div>
      <div class="span-3" style="display:flex;align-items:center;gap:10px">
        <label><input type="checkbox" id="mv_fact"> Factura</label>
        <div id="mv_fact_grp" class="hidden" style="display:flex;gap:10px;flex-wrap:wrap">
          <label>Razón Social <input id="mv_rs" type="text"></label>
          <label>RUC <input id="mv_ruc" type="text"></label>
        </div>
      </div>

      <div class="section-title span-3">ÍTEMS (desde Inventario)</div>

      <div class="span-3" style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center">
        <div>
          <label for="mv_item1">Ítem 1</label>
          <input id="mv_search1" type="text" placeholder="Buscar ítem…">
          <select id="mv_item1"></select>
        </div>
        <div><label>Cant.</label><input id="mv_q1" type="number" min="0" step="1" value="1" style="width:90px"></div>
      </div>

      <div class="span-3" style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center">
        <div>
          <label for="mv_item2">Ítem 2 (opcional)</label>
          <input id="mv_search2" type="text" placeholder="Buscar ítem…">
          <select id="mv_item2"></select>
        </div>
        <div><label>Cant.</label><input id="mv_q2" type="number" min="0" step="1" value="0" style="width:90px"></div>
      </div>

      <div class="span-3" style="display:flex;align-items:center;gap:12px">
        <label><input id="mv_use_desc" type="checkbox"> Aplicar descuento</label>
        <div id="mv_grp_desc" class="hidden" style="display:flex;align-items:center;gap:6px">
          <label for="mv_desc_pct" style="margin:0">Descuento (%)</label>
          <input id="mv_desc_pct" type="number" min="0" max="100" step="1" value="0" style="width:110px">
        </div>
      </div>

      <div class="section-title span-3">PAGO Y ENTREGA</div>
      <div>
        <label class="required" for="mv_pago">Método de pago</label>
        <select id="mv_pago" required>
          <option value="" disabled selected>Seleccionar…</option>
          <option>Efectivo</option><option>QR</option><option>Transferencia</option>
          <option>Tarjeta crédito</option><option>Tarjeta débito</option>
        </select>
      </div>
      <div>
        <label class="required" for="mv_entrega">Tipo de entrega</label>
        <select id="mv_entrega" required><option>Retiro en local</option><option>Delivery</option><option>Encomienda</option></select>
      </div>
      <div id="mv_grp_delivery" class="hidden"><label for="mv_delivery_gps">Dirección / Google Maps (GPS)</label><input id="mv_delivery_gps" type="text"></div>
      <div id="mv_grp_envio_city" class="hidden"><label for="mv_envio_ciudad">Ciudad</label><input id="mv_envio_ciudad" type="text"></div>
      <div id="mv_grp_envio_addr" class="hidden"><label for="mv_envio_dir">Dirección</label><input id="mv_envio_dir" type="text"></div>
    </form>
  </div>
  <div class="modal-footer">
    <span class="total-chip" id="mv_totalChip">Total: Gs. 0</span>
    <button class="btn light" id="mv_cancel">Cancelar</button>
    <button class="btn ok" id="mv_confirm">Confirmar venta</button>
  </div>
</dialog>

<script nonce="figo123">
/* ===== Helpers ===== */
const $=id=>document.getElementById(id);
const sanitize=s=>(s||"").toString().replace(/[<>]/g,"").trim();
const onlyDigits=s=>(s||"").toString().replace(/\D/g,"");
const money=n=>"Gs. "+(Math.max(0,Math.round(Number(n)||0))).toLocaleString("es-PY");
const readAsDataURL=(file)=>new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(file);});
const dateShort=ts=>{const d=new Date(ts); if(isNaN(d)) return "—"; return d.getDate()+"/"+(d.getMonth()+1)+"/"+String(d.getFullYear()).slice(-2);};
const ymd = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
const formatPY=(digits)=>digits.replace(/\B(?=(\d{3})+(?!\d))/g,".");
const parseGs=s=>Number(onlyDigits(s)||0);
const startOfToday = ()=>{const d=new Date(); d.setHours(0,0,0,0); return d;};
const endOfToday   = ()=>{const d=new Date(); d.setHours(23,59,59,999); return d;};
const startOfWeek  = ()=>{const d=new Date(); const dow=(d.getDay()+6)%7; d.setHours(0,0,0,0); d.setDate(d.getDate()-dow); return d;};
const endOfWeek    = ()=>{const s=startOfWeek(); const e=new Date(s); e.setDate(e.getDate()+6); e.setHours(23,59,59,999); return e;};
const startOfMonth = ()=>{const d=new Date(); d.setDate(1); d.setHours(0,0,0,0); return d;};
const endOfMonth   = ()=>{const d=new Date(); d.setMonth(d.getMonth()+1,0); d.setHours(23,59,59,999); return d;};
const startOfYear  = ()=>{const d=new Date(); d.setMonth(0,1); d.setHours(0,0,0,0); return d;};
const endOfYear    = ()=>{const d=new Date(); d.setMonth(11,31); d.setHours(23,59,59,999); return d;};
const inRange=(ts,mode)=>{const t=new Date(ts); if(isNaN(t)) return false;
  if(mode==="Hoy"){return t>=startOfToday() && t<=endOfToday();}
  if(mode==="Semanal"){return t>=startOfWeek() && t<=endOfWeek();}
  if(mode==="Mensual"){return t>=startOfMonth() && t<=endOfMonth();}
  if(mode==="Anual"){return t>=startOfYear() && t<=endOfYear();}
  return true;
};

/* ===== Constantes ===== */
const PRICE_TABLE={Antifluido:145000,Microfibra:140000,"Algodón":135000,Tropical:150000};
const EXTRA_NAME=15000, EXTRA_LOGO=20000;
const EXTRA_CORTE_1=4000, EXTRA_CORTE_2=8000;
const EXTRA_BORDADO_N=7000, EXTRA_BORDADO_L=12000;
const EXTRA_CONF_1=15000, EXTRA_CONF_2=30000;

/* ===== Storage Keys ===== */
const KEY_ORDERS="figo_orders_v2_6";
const KEY_NEXTID="figo_nextid_v2_6";
const KEY_SALES="figo_ventas_v2_6";
const KEY_PAGOS="figo_pagos_v2_6";
const KEY_INV="figo_inventario_v1";
const KEY_USERS="figo_users_v1";
const KEY_AUTH="figo_auth_v2";
const KEY_INVLOG="figo_invlog_v1";
const KEY_AVATAR="figo_avatar_v1";
const load=(k,def)=>{try{const r=localStorage.getItem(k);return r?JSON.parse(r):def;}catch{return def;}};
const save=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch(e){alert("No se pudo guardar en el navegador.");}}; // eslint-disable-line
const nextId=()=>{let n=load(KEY_NEXTID,1);save(KEY_NEXTID,n+1);return n;};

/* ===== Usuarios / Sesión ===== */
function ensureUsers(){
  const u = load(KEY_USERS, null);
  if(!u){
    save(KEY_USERS,[{user:"Nicolás",pass:"Dinosaurio98",role:"admin"}]);
  }else{
    const i = u.findIndex(x => x.user === "Nicolás");
    if(i >= 0 && u[i].pass !== "Dinosaurio98"){
      u[i].pass = "Dinosaurio98";
      save(KEY_USERS, u);
    }
  }
}
function getUsers(){return load(KEY_USERS,[]);}
function setUsers(arr){save(KEY_USERS,arr);}
function getAuth(){return load(KEY_AUTH,null);}
function setAuth(a){if(a) save(KEY_AUTH,a); else localStorage.removeItem(KEY_AUTH);}
function isSessionValid(){ const a=getAuth(); if(!a) return false; return Date.now() < (a.exp||0); }
function currentUser(){const a=getAuth(); return a?.user||null;}
function currentRole(){const a=getAuth(); return a?.role||"usuario";}

/* ===== Avatar (perfil local) ===== */
function loadAvatar(){
  try{
    const data=localStorage.getItem(KEY_AVATAR);
    const img=$("avatarImg");
    if(data && img){ img.src=data; }
  }catch{}
}
$("avatar")?.addEventListener("click",()=>$("avatarFile").click());
$("avatarFile")?.addEventListener("change",async(e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const data=await readAsDataURL(f);
  try{ localStorage.setItem(KEY_AVATAR,data); }catch{}
  const img=$("avatarImg");
  if(img){ img.src=data; }
});

/* ===== UI por rol ===== */
function applyRoleUI(){
  const role=currentRole();
  document.querySelectorAll(".pill-admin").forEach(el=>{ el.style.display = (role==="admin")?"inline-block":"none"; });
  // "Nuevo ítem" habilitado para todos los usuarios autenticados
  $("btnNuevoItem").style.display = "inline-block";
}

/* ===== Navegación de tabs ===== */
const tabsMap={pedidos:"tab-pedidos",inventario:"tab-inventario",corte:"tab-corte",bordado:"tab-bordado",confeccion:"tab-confeccion",listos:"tab-listos",falta:"tab-falta",ventas:"tab-ventas",stats:"tab-stats",config:"tab-config"};
$("tabsNav").addEventListener("click",(e)=>{
  const b=e.target.closest(".pill"); if(!b) return;
  document.querySelectorAll("nav .pill").forEach(p=>p.classList.remove("active"));
  b.classList.add("active");
  const t=b.dataset.tab;
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  $(tabsMap[t]).classList.add("active");
  renderAll();
});

/* ===== Guardas de login para acciones ===== */
let postLoginAction=null;
function requireLogin(then){
  if(isSessionValid()){ then(); return; }
  postLoginAction=then; showLogin();
}

/* ===== Modales base ===== */
const modal=$("modalPedido");
function openNuevoPedido(){
  editingOrderId=null;$("tituloNP").textContent="Nuevo Pedido";
  $("formPedido").reset(); $("np_senia").value="0"; toggle($("grp_nombre_bordar"),false); toggle($("grp_letra_color"),false); toggle($("grp_logo_file"),false); toggle($("grp_desc"),false);
  recalc(); modal.showModal();
}
$("btnNuevoPedido").addEventListener("click",()=>requireLogin(openNuevoPedido));
$("btnCerrarModal").addEventListener("click",()=>modal.close());
$("btnCancelarPedido").addEventListener("click",()=>modal.close());
const toggle=(el,show)=>el.classList[show?"remove":"add"]("hidden");
$("np_b_nombre").addEventListener("input",()=>{
  const on = $("np_b_nombre").value==="Sí";
  toggle($("grp_nombre_bordar"),on);
  toggle($("grp_letra_color"),on);
  recalc();
});
$("np_b_logo").addEventListener("input",()=>{toggle($("grp_logo_file"),$("np_b_logo").value==="Sí");recalc();});
$("np_use_desc").addEventListener("change",()=>{toggle($("grp_desc"),$("np_use_desc").checked);recalc();});
$("np_entrega").addEventListener("input",()=>{const v=$("np_entrega").value;toggle($("grp_delivery"),v==="Delivery");const isEnv=v==="Encomienda";toggle($("grp_envio_city"),isEnv);toggle($("grp_envio_addr"),isEnv);});

/* Mayúsculas automáticas en chomba/pantalón */
["np_chomba","np_pantalon"].forEach(id=>{
  $(id).addEventListener("input",e=>{ e.target.value = (e.target.value||"").toUpperCase(); recalc(); });
});

/* ===== Cálculo modal Pedido ===== */
const recalc=()=>{const tela=$("np_tela").value, ch=sanitize($("np_chomba").value), pa=sanitize($("np_pantalon").value);
  const bN=$("np_b_nombre").value==="Sí", bL=$("np_b_logo").value==="Sí";
  const useDesc=$("np_use_desc").checked, descPct=Math.min(100,Math.max(0,Number($("np_desc_pct").value||0)));
  const prendas=(ch?1:0)+(pa?1:0);
  const base=(PRICE_TABLE[tela]||0)*prendas, extras=(bN?EXTRA_NAME:0)+(bL?EXTRA_LOGO:0);
  const subtotal=base+extras, subtotalDesc=useDesc?Math.round(subtotal*(1-descPct/100)):subtotal;
  const senia=parseGs($("np_senia").value);
  const totalMostrar=Math.max(0,subtotalDesc-senia);
  $("np_subtotal").textContent=money(subtotal);
  $("np_total").value=totalMostrar;
  $("chipTotal").textContent="Total: "+money(totalMostrar);
  const telDigits=onlyDigits($("np_tel").value), codigo=telDigits.slice(-3).padStart(3,"0");
  $("np_resumen_list").innerHTML=[
    `<li><b>Código:</b> ${codigo||"—"}</li>`,
    `<li><b>Cliente:</b> ${sanitize($("np_nombre").value)||"—"}</li>`,
    `<li><b>Teléfono:</b> ${sanitize($("np_tel").value)||"—"}</li>`,
    `<li><b>Tela/Color:</b> ${(tela||"—")} / ${sanitize($("np_color").value)||"—"}</li>`,
    `<li><b>Modelo:</b> ${sanitize($("np_modelo").value)||"—"}</li>`,
    `<li><b>Chomba:</b> ${ch||"—"}</li>`,
    `<li><b>Pantalón:</b> ${pa||"—"}</li>`,
    `<li><b>Bordado Nombre:</b> ${bN?"Sí":"No"}</li>`,
    `<li><b>Bordado Logo:</b> ${bL?"Sí":"No"}</li>`
  ].join("");
};
["np_tela","np_color","np_modelo","np_chomba","np_pantalon","np_b_nombre","np_b_logo","np_desc_pct","np_tel","np_nombre","np_letra_color"].forEach(id=>$(id).addEventListener("input",recalc));

/* Seña con puntos */
$("np_senia").addEventListener("input",()=>{const d=onlyDigits($("np_senia").value);$("np_senia").value = d ? formatPY(d) : "";recalc();});
$("np_use_desc").addEventListener("change",recalc);

/* Validación */
const requiredIds=["np_nombre","np_tel","np_genero","np_tela","np_senia","np_pago","np_entrega"];
const isValid=()=>{for(const id of requiredIds){const el=$(id);if(!el.value){el.focus();return false;}}if($("np_b_nombre").value==="Sí"&&!$("np_nombre_bordar").value.trim()){ $("np_nombre_bordar").focus();return false;}if($("np_b_nombre").value==="Sí"&&!$("np_letra_color").value.trim()){ $("np_letra_color").focus();return false;}if($("np_b_logo").value==="Sí"&&!$("np_logo_file").files.length){$("np_logo_file").focus();return false;}return true;};

/* ===== Ledger de pagos ===== */
const logPago=(p)=>{const arr=load(KEY_PAGOS,[]);arr.push(p);save(KEY_PAGOS,arr);} ;

/* ===== Inventario ===== */
const tallaOrder=["XP","P","M","G","XG","2XG","3XG"];
const invKey=(it)=>[it.genero,it.categoria,it.tela,it.color.toUpperCase(),it.talle].join("|");
const invGetAll=()=>load(KEY_INV,[]);
const invSaveAll=(arr)=>save(KEY_INV,arr);
const invUpsert=(it)=>{const arr=invGetAll(); const key=invKey(it); const found=arr.find(x=>invKey(x)===key);
  if(found){found.stock=(Number(found.stock)||0)+(Number(it.stock)||0);found.desc=it.desc||found.desc;found.precio=precioPrenda(it.tela);}
  else{arr.push({...it,precio:precioPrenda(it.tela),id:key});}
  invSaveAll(arr);
};
const precioPrenda=(tela)=>PRICE_TABLE[tela]||0;

/* ===== Log de inventario ===== */
function invLogPush(ev){const log=load(KEY_INVLOG,[]);log.push(ev);save(KEY_INVLOG,log);}
function renderInvLog(){
  const mode=$("invLogRange").value||"Hoy";
  const log=load(KEY_INVLOG,[]);
  const body=$("tbl-invlog").querySelector("tbody"); body.innerHTML="";
  const rows=log.filter(e=>inRange(e.ts,mode)).sort((a,b)=>new Date(b.ts)-new Date(a.ts));
  if(!rows.length){body.innerHTML=`<tr><td colspan="4" class="muted">Sin movimientos para el rango.</td></tr>`;return;}
  rows.forEach(e=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${dateShort(e.ts)}</td><td>${e.user||"—"}</td><td>${e.action}</td><td>${sanitize(e.detail||"—")}</td>`;
    body.appendChild(tr);
  });
}

/* ===== Guardar pedido (nuevo / edición) ===== */
let editingOrderId=null;
$("btnGuardarPedido").addEventListener("click",async()=>{
  if(!isValid()){alert("Completá los campos obligatorios.");return;}
  recalc();
  const orders=load(KEY_ORDERS,[]), sales=load(KEY_SALES,[]);
  let id=editingOrderId??nextId();
  const telDigits=onlyDigits($("np_tel").value), codigo=telDigits.slice(-3).padStart(3,"0");
  const bNombre=$("np_b_nombre").value==="Sí", bLogo=$("np_b_logo").value==="Sí";
  const useDesc=$("np_use_desc").checked, descPct=Math.min(100,Math.max(0,Number($("np_desc_pct").value||0)));
  const tela=$("np_tela").value, ch=$("np_chomba").value.trim(), pa=$("np_pantalon").value.trim();
  const prendas=(ch?1:0)+(pa?1:0);
  const base=(PRICE_TABLE[tela]||0)*prendas, extras=(bNombre?EXTRA_NAME:0)+(bLogo?EXTRA_LOGO:0);
  const subtotal=base+extras, subtotalDesc=useDesc?Math.round(subtotal*(1-descPct/100)):subtotal;
  const senia=parseGs($("np_senia").value);
  const file=$("np_logo_file").files[0]; const logo_data=file?await readAsDataURL(file): (editingOrderId?undefined:"");
  const prev=orders.find(x=>x.id===id);
  const payload={
    id, ts: (editingOrderId? (prev?.ts || new Date().toISOString()) : new Date().toISOString()), codigo,
    creado_por: currentUser()||"—",
    cliente:{nombre:sanitize($("np_nombre").value),tel:sanitize($("np_tel").value),email:sanitize($("np_email").value),razon_social:sanitize($("np_rs").value),ruc:sanitize($("np_ruc").value),genero:sanitize($("np_genero").value)},
    especificaciones:{tela:sanitize($("np_tela").value),color:sanitize($("np_color").value),modelo:sanitize($("np_modelo").value),chomba:sanitize($("np_chomba").value),pantalon:sanitize($("np_pantalon").value),notas:sanitize($("np_notas").value)},
    bordados:{
      nombre:bNombre,nombre_texto:sanitize($("np_nombre_bordar").value),
      logo:bLogo,logo_filename:file?.name || (prev?.bordados?.logo_filename||""),
      logo_data: (logo_data===undefined? (prev?.bordados?.logo_data || "") : logo_data),
      letra_color: sanitize($("np_letra_color").value),
      otras_especificaciones_bordado:(prev?.bordados?.otras_especificaciones_bordado||"")
    },
    entrega:{tipo:$("np_entrega").value,gps:sanitize($("np_delivery_gps").value),ciudad:sanitize($("np_envio_ciudad").value),direccion:sanitize($("np_envio_dir").value),encomienda_pagada:(prev?.entrega?.encomienda_pagada||false),pago_al_recibir:(prev?.entrega?.pago_al_recibir||false)},
    costos:{
      regla:PRICE_TABLE,extra_nombre:EXTRA_NAME,extra_logo:EXTRA_LOGO,
      subtotal,descuento_pct:useDesc?descPct:0,subtotal_desc:subtotalDesc,total:subtotalDesc,
      pagado: editingOrderId? (prev?.costos?.pagado ?? 0) : senia,
      senia_inicial: editingOrderId? (prev?.costos?.senia_inicial ?? 0) : senia,
      extra_corte:(prev?.costos?.extra_corte||0),extra_corte_pagado:(prev?.costos?.extra_corte_pagado||false),
      extra_bordado:(prev?.costos?.extra_bordado||0),extra_bordado_pagado:(prev?.costos?.extra_bordado_pagado||false),
      extra_confeccion:(prev?.costos?.extra_confeccion||0),extra_confeccion_pagado:(prev?.costos?.extra_confeccion_pagado||false)
    },
    estado: editingOrderId? (prev?.estado || {etapa:"Corte",recibido:false,bordado_recibido:false,confeccion_ok:false,listo:false,enviado:false,ts_envio:""}) : {etapa:"Corte",recibido:false,bordado_recibido:false,confeccion_ok:false,listo:false,enviado:false,ts_envio:""}
  };

  if(editingOrderId){
    const idx=orders.findIndex(x=>x.id===id);
    if(idx>=0) orders[idx]=payload; else orders.push(payload);
    alert("✏️ Pedido actualizado.");
  }else{
    orders.push(payload);
    if(senia>0){ logPago({ts:payload.ts,pedido_id:id,cliente:payload.cliente.nombre,tel:payload.cliente.tel,metodo:$("np_pago").value,concepto:"Seña",monto:senia}); }
    const sales=load(KEY_SALES,[]); sales.push({ts:payload.ts,tipo:"pedido_creado",pedido_id:id,codigo:payload.codigo,pagado_inicial:senia,total:payload.costos.total,creado_por:currentUser()||"—"}); save(KEY_SALES,sales);
    alert("✅ Pedido guardado. Está en 'Pedidos' y etapa 'Corte'.");
  }
  save(KEY_ORDERS,orders);
  $("formPedido").reset(); $("np_senia").value="0"; recalc(); modal.close(); editingOrderId=null; renderAll();
});

/* ===== Utilidades de pedido ===== */
const fmtUlt3=tel=>onlyDigits(tel).slice(-3).padStart(3,"0");
const yesno=b=>b?"Sí":"No";
const prendasCount=o=>(o.especificaciones.chomba?1:0)+(o.especificaciones.pantalon?1:0);
const feeCorte=o=>{const n=prendasCount(o);return n>=2?EXTRA_CORTE_2:(n===1?EXTRA_CORTE_1:0);};
const feeBordado=o=>(o.bordados.nombre?EXTRA_BORDADO_N:0)+(o.bordados.logo?EXTRA_BORDADO_L:0);
const feeConf=o=>{const n=prendasCount(o);return n>=2?EXTRA_CONF_2:(n===1?EXTRA_CONF_1:0);};
const saldo=o=>Math.max(0,(o.costos.total+(o.costos.extra_corte||0)+(o.costos.extra_bordado||0)+(o.costos.extra_confeccion||0))-(o.costos.pagado||0));
const entregaDetalle=o=>{ if(o.entrega?.tipo==="Delivery") return o.entrega.gps?o.entrega.gps:"Delivery (GPS no cargado)";
  if(o.entrega?.tipo==="Encomienda"){const city=o.entrega.ciudad||"—", dir=o.entrega.direccion||"—"; return `Encomienda · ${city} · ${dir}`;}
  return "Retiro en local";
};

/* ===== Estado de resalte ===== */
let highlightedOrderId=null;
const gotoPedidoAndHighlight=(id)=>{ highlightedOrderId=Number(id)||null;
  document.querySelectorAll("nav .pill").forEach(p=>p.classList.remove("active"));
  document.querySelector('nav .pill[data-tab="pedidos"]').classList.add("active");
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  $("tab-pedidos").classList.add("active");
  renderAll();
};
const focusHighlightedRow=()=>{ if(!highlightedOrderId) return;
  const row=$(`#tbl-pedidos tbody tr[data-id="${highlightedOrderId}"]`);
  if(row){row.classList.add("row-highlight"); row.scrollIntoView({behavior:"smooth",block:"center"});}
  setTimeout(()=>{highlightedOrderId=null; renderPedidos();},4000);
};

/* ===== Renders ===== */
function renderPedidos(){
  const orders=load(KEY_ORDERS,[]).filter(o=>o.estado.etapa!=="Ventas");
  const q=(sanitize($("searchBox").value)||"").toLowerCase();
  const body=$("tbl-pedidos").querySelector("tbody"); body.innerHTML="";
  const fil=orders.filter(o=>{
    const hay=[o.cliente?.nombre,o.cliente?.tel,o.codigo,o.cliente?.ruc,o.cliente?.razon_social,o.cliente?.email,(o.estado?.etapa||""),(o.creado_por||"")].join(" ").toLowerCase();
    return !q || hay.includes(q);
  }).slice().reverse();

  fil.forEach(o=>{
    const s=saldo(o);
    const tr=document.createElement("tr");
    tr.dataset.id=o.id;
    tr.innerHTML=`
      <td>${o.id}</td>
      <td>${dateShort(o.ts)}</td>
      <td>${o.cliente.nombre||"—"}${o.creado_por?`<div class="byline">por ${o.creado_por}</div>`:""}</td>
      <td>${o.cliente.tel||"—"}</td>
      <td>${o.cliente.razon_social||"—"}</td>
      <td>${o.cliente.ruc||"—"}</td>
      <td>${o.estado.etapa}</td>
      <td>${money(o.costos.senia_inicial||0)}</td>
      <td>${money(o.costos.total)}</td>
      <td>${s>0?`<span class="fee red">${money(s)}</span>`:`<span class="fee green">${money(0)}</span>`}</td>
      <td><button class="btn light sm" data-act="p-detalle" data-id="${o.id}">Ver detalle</button></td>
    `;
    body.appendChild(tr);
  });
  if(highlightedOrderId) focusHighlightedRow();
}

function renderInventario(){
  const gen=$("invFilterGen").value||"Todos";
  const talle=$("invFilterTalle").value||"Todos";
  const mode=$("invGroupMode").value||"Conjunto";
  const body=$("tbl-inv").querySelector("tbody"); body.innerHTML="";
  let items=invGetAll().slice();
  items=items.filter(it=>{ if(gen!=="Todos" && it.genero!==gen) return false; if(talle!=="Todos" && it.talle!==talle) return false; return true; });

  const pushRow=(arr, idx, genero, categoria, tela, color, talle, stock, precio, desc)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${idx}</td>
      <td>${genero}</td>
      <td>${categoria}</td>
      <td>${tela}</td>
      <td>${color}</td>
      <td>${talle}</td>
      <td><b>${stock}</b></td>
      <td>${precio?money(precio):"—"}</td>
      <td>${sanitize(desc||"—")}</td>
    `;
    arr.appendChild(tr);
  };

  if(mode==="Conjunto"){
    const byKey={};
    items.forEach(it=>{
      const k=[it.genero,it.tela,it.color.toUpperCase(),it.talle].join("|");
      byKey[k]=byKey[k]||{ch:0,pa:0,precio:precioPrenda(it.tela),genero:it.genero,tela:it.tela,color:it.color,talle:it.talle};
      if(it.categoria==="Chomba") byKey[k].ch+=Number(it.stock)||0;
      if(it.categoria==="Pantalón") byKey[k].pa+=Number(it.stock)||0;
    });
    const groups=Object.values(byKey).map(g=>({...g,stock:Math.min(g.ch,g.pa)}))
      .filter(g=>g.stock>0)
      .sort((a,b)=>{ if(a.genero!==b.genero) return a.genero.localeCompare(b.genero);
        const ta=tallaOrder.indexOf(a.talle), tb=tallaOrder.indexOf(b.talle);
        if(ta!==tb) return ta-tb; return (a.color||"").localeCompare(b.color||""); });
    if(!groups.length){body.innerHTML=`<tr><td colspan="9" class="muted">Sin conjuntos con stock.</td></tr>`; $("invSum").textContent="—"; return;}
    let sum=0; groups.forEach((g,i)=>{sum+=g.stock; pushRow(body,i+1,g.genero,"Conjunto",g.tela,g.color,g.talle,g.stock,g.precio,"Chomba + Pantalón");});
    $("invSum").textContent=`Conjuntos: ${groups.length} · Unidades conj.: ${sum}`; return;
  }

  items.sort((a,b)=>{ if(a.genero!==b.genero) return a.genero.localeCompare(b.genero);
    const ta=tallaOrder.indexOf(a.talle), tb=tallaOrder.indexOf(b.talle);
    if(ta!==tb) return ta-tb; if(a.color!==b.color) return (a.color||"").localeCompare(b.color||""); return a.categoria.localeCompare(b.categoria);});
  if(!items.length){body.innerHTML=`<tr><td colspan="9" class="muted">Sin ítems.</td></tr>`; $("invSum").textContent="—"; return;}
  let sum=0, count=0; items.forEach((it,idx)=>{sum+=Number(it.stock)||0; count++; pushRow(body,idx+1,it.genero,it.categoria,it.tela,it.color,it.talle,it.stock,it.precio,it.desc);});
  $("invSum").textContent=`Ítems: ${count} · Unidades totales: ${sum}`;
}

const collectTalles=orders=>{const set=new Set();orders.forEach(o=>{if(o.especificaciones?.chomba)set.add(o.especificaciones.chomba.toUpperCase());if(o.especificaciones?.pantalon)set.add(o.especificaciones.pantalon.toUpperCase());});return ["Todos",...Array.from(set).filter(Boolean).sort()];};
const applyOptions=(sel,opts)=>{const v=sel.value;sel.innerHTML=opts.map(op=>`<option${op===v?' selected':''}>${op}</option>`).join("");};

function renderCorte(){
  const all=load(KEY_ORDERS,[]), orders=all.filter(o=>o.estado.etapa==="Corte");
  applyOptions($("corteFilter"),collectTalles(orders));
  const talle=$("corteFilter").value||"Todos";
  const generoSel=$("corteGender").value||"Todos";

  // Cambiar esquema de color del tab según género
  const corteTab=$("tab-corte");
  if(generoSel==="Masculino"){ corteTab.classList.add("gender-masculino"); corteTab.classList.remove("gender-femenino"); }
  else { corteTab.classList.add("gender-femenino"); corteTab.classList.remove("gender-masculino"); }

  // Filtro por género
  let list=orders.filter(o=>{
    if(talle!=="Todos"){
      const tU=(o.especificaciones.chomba||"").toUpperCase();
      const pU=(o.especificaciones.pantalon||"").toUpperCase();
      if(tU!==talle&&pU!==talle) return false;
    }
    if(generoSel!=="Todos" && (o.cliente.genero||"")!==generoSel) return false;
    return true;
  });

  // Ordenar por Tela → Color → Talle (XP,P,M,G,XG,2XG,3XG)
  list.sort((a,b)=>{
    const A=a.especificaciones||{}, B=b.especificaciones||{};
    const t=(A.tela||"").localeCompare(B.tela||""); if(t) return t;
    const c=(A.color||"").localeCompare(B.color||""); if(c) return c;
    const ta=(A.chomba||A.pantalon||"").toUpperCase();
    const tb=(B.chomba||B.pantalon||"").toUpperCase();
    const ia=tallaOrder.indexOf(ta); const ib=tallaOrder.indexOf(tb);
    return (ia-ib);
  });

  const body=$("tbl-corte").querySelector("tbody"); body.innerHTML="";
  let selected=0, extraPendTotal=0;
  list.forEach(o=>{
    const checked=o.estado.recibido===true, fee=checked?feeCorte(o):0, isPaid=Boolean(o.costos.extra_corte_pagado);
    const tr=document.createElement("tr"); tr.innerHTML=`
      <td><button class="linkbtn" data-act="gotoPedido" data-id="${o.id}">${o.id}</button></td>
      <td>${fmtUlt3(o.cliente.tel)}</td><td>${o.cliente.genero||"—"}</td>
      <td>${o.especificaciones.tela||"—"}</td><td>${o.especificaciones.color||"—"}</td>
      <td>${o.especificaciones.chomba||"—"}</td><td>${o.especificaciones.modelo||"—"}</td><td>${o.especificaciones.pantalon||"—"}</td>
      <td>${yesno(o.bordados.nombre)}</td><td>${yesno(o.bordados.logo)}</td><td>${o.especificaciones.notas||"—"}</td>
      <td style="white-space:nowrap">
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" data-act="corteRec" data-id="${o.id}" ${checked?"checked":""}>
          ${checked?(isPaid?`<span class="fee green">Pagado</span>`:`<span class="fee red">+ ${money(fee)}</span>`):``}
        </label>
      </td>`;
    body.appendChild(tr);
    if(checked){selected++;o.costos.extra_corte=feeCorte(o); if(!isPaid) extraPendTotal+=o.costos.extra_corte||0;} else {o.costos.extra_corte=0;o.costos.extra_corte_pagado=false;}
  });
  save(KEY_ORDERS,all); $("corteCount").textContent="Recibidos seleccionados: "+selected; $("corteExtraPend").textContent=money(extraPendTotal);
  body.querySelectorAll('input[data-act="corteRec"]').forEach(cb=>cb.addEventListener("change",(e)=>{const id=Number(e.target.dataset.id);const arr=load(KEY_ORDERS,[]);const oo=arr.find(x=>x.id===id);if(!oo)return;oo.estado.recibido=e.target.checked;if(!e.target.checked){oo.costos.extra_corte=0;oo.costos.extra_corte_pagado=false;} save(KEY_ORDERS,arr);renderCorte();}));
  $("btnCortePagar").onclick=()=>{const arr=load(KEY_ORDERS,[]);arr.forEach(x=>{if(x.estado.etapa==="Corte"&&x.estado.recibido){const f=feeCorte(x);if(f>0&&!x.costos.extra_corte_pagado){x.costos.extra_corte=f;x.costos.extra_corte_pagado=true;x.costos.pagado=(x.costos.pagado||0)+f;}}});save(KEY_ORDERS,arr);renderCorte();renderPedidos();renderFalta();renderVentas();renderStats();};
  $("btnCorteToNext").onclick=()=>{const arr=load(KEY_ORDERS,[]);arr.forEach(x=>{if(x.estado.etapa==="Corte"&&x.estado.recibido){const tieneB=Boolean(x.bordados?.nombre||x.bordados?.logo);x.estado.etapa=tieneB?"Bordado":"Confección";}});save(KEY_ORDERS,arr);renderAll();};
}

function renderBordado(){
  const all=load(KEY_ORDERS,[]), orders=all.filter(o=>(o.bordados.nombre||o.bordados.logo)&&o.estado.etapa==="Bordado");
  applyOptions($("bordadoFilter"),collectTalles(orders));
  const talle=$("bordadoFilter").value||"Todos", body=$("tbl-bordado").querySelector("tbody"); body.innerHTML="";
  let selected=0, extraPendTotal=0;
  orders.forEach(o=>{
    if(talle!=="Todos"){const tU=(o.especificaciones.chomba||"").toUpperCase(), pU=(o.especificaciones.pantalon||"").toUpperCase(); if(tU!==talle&&pU!==talle)return;}
    const checked=o.estado.bordado_recibido===true, fee=checked?feeBordado(o):0, isPaid=Boolean(o.costos.extra_bordado_pagado);
    const tr=document.createElement("tr"); tr.innerHTML=`
      <td><button class="linkbtn" data-act="gotoPedido" data-id="${o.id}">${o.id}</button></td>
      <td>${fmtUlt3(o.cliente.tel)}</td><td>${o.cliente.genero||"—"}</td>
      <td>${o.especificaciones.tela||"—"}</td><td>${o.especificaciones.color||"—"}</td>
      <td>${o.especificaciones.chomba||"—"}</td><td>${o.especificaciones.modelo||"—"}</td>
      <td>${o.bordados.nombre?(o.bordados.nombre_texto||"—"):"—"}</td>
      <td>${o.bordados.letra_color||"—"}</td>
      <td>${o.bordados.logo&&o.bordados.logo_data?`<img src="${o.bordados.logo_data}" alt="logo" style="width:40px;height:40px;object-fit:contain;border:1px solid #e5e7eb;border-radius:6px">`:(o.bordados.logo?(o.bordados.logo_filename||"Sí"):"—")}</td>
      <td>${o.bordados.otras_especificaciones_bordado||""}</td>
      <td style="white-space:nowrap">
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" data-act="bordadoRec" data-id="${o.id}" ${checked?"checked":""}>
          ${checked?(isPaid?`<span class="fee green">Pagado</span>`:`<span class="fee red">+ ${money(fee)}</span>`):``}
        </label>
      </td>`;
    body.appendChild(tr);
    if(checked){selected++;o.costos.extra_bordado=feeBordado(o); if(!isPaid) extraPendTotal+=o.costos.extra_bordado||0;} else {o.costos.extra_bordado=0;o.costos.extra_bordado_pagado=false;}
  });
  save(KEY_ORDERS,all); $("bordadoCount").textContent="Recibidos seleccionados: "+selected; $("bordadoExtraPend").textContent=money(extraPendTotal);
  body.querySelectorAll('input[data-act="bordadoRec"]').forEach(cb=>cb.addEventListener("change",(e)=>{const id=Number(e.target.dataset.id);const arr=load(KEY_ORDERS,[]);const o=arr.find(x=>x.id===id);if(!o)return;o.estado.bordado_recibido=e.target.checked;if(!e.target.checked){o.costos.extra_bordado=0;o.costos.extra_bordado_pagado=false;}else{o.costos.extra_bordado=feeBordado(o);}save(KEY_ORDERS,arr);renderBordado();renderPedidos();renderFalta();renderVentas();renderStats();}));
  $("btnBordadoPagar").onclick=()=>{const arr=load(KEY_ORDERS,[]);arr.forEach(x=>{if(x.estado.etapa==="Bordado"&&x.estado.bordado_recibido){const f=feeBordado(x);if(f>0&&!x.costos.extra_bordado_pagado){x.costos.extra_bordado=f;x.costos.extra_bordado_pagado=true;x.costos.pagado=(x.costos.pagado||0)+f;}}});save(KEY_ORDERS,arr);renderBordado();renderPedidos();renderFalta();renderVentas();renderStats();};
  $("btnBordadoToNext").onclick=()=>{const arr=load(KEY_ORDERS,[]);arr.forEach(x=>{if(x.estado.etapa==="Bordado"&&x.estado.bordado_recibido){x.estado.etapa="Confección";}});save(KEY_ORDERS,arr);renderAll();};
}

function renderConf(){
  const arr=load(KEY_ORDERS,[]), orders=arr.filter(o=>o.estado.etapa==="Confección");
  applyOptions($("confFilter"),collectTalles(orders));
  const talle=$("confFilter").value||"Todos", body=$("tbl-conf").querySelector("tbody"); body.innerHTML="";
  let extraPendTotal=0;
  orders.forEach(o=>{
    if(talle!=="Todos"){const tU=(o.especificaciones.chomba||"").toUpperCase(), pU=(o.especificaciones.pantalon||"").toUpperCase(); if(tU!==talle&&pU!==talle)return;}
    const checked=o.estado.confeccion_ok===true, fee=checked?feeConf(o):0, isPaid=Boolean(o.costos.extra_confeccion_pagado);
    const tr=document.createElement("tr"); tr.innerHTML=`
      <td><button class="linkbtn" data-act="gotoPedido" data-id="${o.id}">${o.id}</button></td>
      <td>${fmtUlt3(o.cliente.tel)}</td><td>${o.cliente.genero||"—"}</td>
      <td>${o.especificaciones.tela||"—"}</td><td>${o.especificaciones.color||"—"}</td>
      <td>${o.especificaciones.chomba||"—"}</td><td>${o.especificaciones.modelo||"—"}</td>
      <td>${o.especificaciones.pantalon||"—"}</td>
      <td>${yesno(o.bordados.nombre)}</td><td>${yesno(o.bordados.logo)}</td>
      <td>${o.especificaciones.notas||"—"}</td>
      <td style="white-space:nowrap">
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" data-act="confok" data-id="${o.id}" ${checked?"checked":""}>
          ${checked?(isPaid?`<span class="fee green">Pagado</span>`:`<span class="fee red">+ ${money(fee)}</span>`):``}
        </label>
      </td>`;
    body.appendChild(tr);
    if(checked){o.costos.extra_confeccion=feeConf(o); if(!isPaid) extraPendTotal+=o.costos.extra_confeccion||0;} else {o.costos.extra_confeccion=0;o.costos.extra_confeccion_pagado=false;}
  });
  save(KEY_ORDERS,arr); $("confExtraPend").textContent=money(extraPendTotal);

  body.querySelectorAll('input[data-act="confok"]').forEach(cb=>cb.addEventListener("change",(e)=>{const id=Number(e.target.dataset.id);const all=load(KEY_ORDERS,[]);const o=all.find(x=>x.id===id);if(!o)return;o.estado.confeccion_ok=e.target.checked;if(!e.target.checked){o.costos.extra_confeccion=0;o.costos.extra_confeccion_pagado=false;}else{o.costos.extra_confeccion=feeConf(o);}save(KEY_ORDERS,all);renderConf();}));

  $("btnConfPagar").onclick=()=>{const all=load(KEY_ORDERS,[]);all.forEach(x=>{if(x.estado.etapa==="Confección"&&x.estado.confeccion_ok){const f=feeConf(x);if(f>0&&!x.costos.extra_confeccion_pagado){x.costos.extra_confeccion=f;x.costos.extra_confeccion_pagado=true;x.costos.pagado=(x.costos.pagado||0)+f;}}});save(KEY_ORDERS,all);renderConf();renderPedidos();renderFalta();renderVentas();renderStats();};
  $("btnConfToNext").onclick=()=>{const all=load(KEY_ORDERS,[]);all.forEach(x=>{if(x.estado.etapa==="Confección"&&x.estado.confeccion_ok){x.estado.etapa="Listo";x.estado.listo=true;}});save(KEY_ORDERS,all);renderAll();};
}

function renderListos(){
  const orders=load(KEY_ORDERS,[]).filter(o=>o.estado.etapa==="Listo");
  const body=$("tbl-listos").querySelector("tbody"); body.innerHTML="";
  orders.forEach(o=>{
    const s=saldo(o);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><button class="linkbtn" data-act="gotoPedido" data-id="${o.id}">${o.id}</button></td>
      <td>${o.cliente.nombre||"—"}${o.creado_por?`<div class="byline">por ${o.creado_por}</div>`:""}</td>
      <td>${o.cliente.tel||"—"}</td>
      <td>${entregaDetalle(o)}</td>
      <td>${s>0?`<span class="fee red">${money(s)}</span>`:`<span class="fee green">${money(0)}</span>`}</td>
      <td><label style="display:flex;align-items:center;gap:6px"><input type="checkbox" data-act="cod" data-id="${o.id}" ${o.entrega.pago_al_recibir?"checked":""}> Efectivo al recibir</label></td>
      <td>${o.estado.enviado?`<span class="fee green">Enviado</span>`:`<button class="btn light" data-act="enviar" data-id="${o.id}">Marcar Enviado</button>`}</td>
    `;
    body.appendChild(tr);
  });

  body.querySelectorAll('input[data-act="cod"]').forEach(cb=>{
    cb.addEventListener("change",(e)=>{const id=Number(e.target.dataset.id);const arr=load(KEY_ORDERS,[]);const o=arr.find(x=>x.id===id);if(!o)return;o.entrega.pago_al_recibir=e.target.checked;save(KEY_ORDERS,arr);});
  });
}

const metodoOptions=`<option>Efectivo</option><option>QR</option><option>Transferencia</option><option>Tarjeta crédito</option><option>Tarjeta débito</option>`;
function renderFalta(){
  const orders=load(KEY_ORDERS,[]).filter(o=>saldo(o)>0);
  const body=$("tbl-falta").querySelector("tbody"); body.innerHTML="";
  if(!orders.length){body.innerHTML=`<tr><td colspan="8" class="muted">Sin registros.</td></tr>`; return;}
  orders.slice().reverse().forEach(o=>{
    const s=saldo(o);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><button class="linkbtn" data-act="gotoPedido" data-id="${o.id}">${o.id}</button></td>
      <td>${o.cliente.nombre}${o.creado_por?`<div class="byline">por ${o.creado_por}</div>`:""}</td>
      <td>${o.cliente.tel}</td>
      <td>${money(o.costos.senia_inicial||0)}</td>
      <td>${money(o.costos.total+(o.costos.extra_corte||0)+(o.costos.extra_bordado||0)+(o.costos.extra_confeccion||0))}</td>
      <td><span class="fee red">${money(s)}</span></td>
      <td><select data-act="metodo" data-id="${o.id}">${metodoOptions}</select></td>
      <td><button class="btn ok" data-act="paySaldo" data-id="${o.id}">Registrar pago</button></td>
    `;
    body.appendChild(tr);
  });
}

function renderVentas(){
  const mode=$("ventasRange")?.value||"Predeterminado";
  const all=load(KEY_ORDERS,[]).filter(o=>o.estado.etapa==="Ventas"||o.estado.enviado===true);
  const orders=all.filter(o=>o.estado.ts_envio && inRange(o.estado.ts_envio,mode));
  const body=$("tbl-ventas").querySelector("tbody"); body.innerHTML="";
  $("ventasCount").textContent = `Ventas: ${orders.length}`;
  if(!orders.length){body.innerHTML=`<tr><td colspan="8" class="muted">Sin ventas para el rango seleccionado.</td></tr>`; return;}
  const byDay={}; orders.forEach(o=>{const d=ymd(new Date(o.estado.ts_envio)); (byDay[d]=byDay[d]||[]).push(o);});
  const days=Object.keys(byDay).sort().reverse();

  const pushOrderRow=(o)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><button class="linkbtn" data-act="gotoPedido" data-id="${o.id}">${o.id}</button></td>
      <td>${o.estado.ts_envio?dateShort(o.estado.ts_envio):"—"}</td>
      <td>${o.cliente.nombre||"—"}${o.creado_por?`<div class="byline">por ${o.creado_por}</div>`:""}</td>
      <td>${o.cliente.tel||"—"}</td>
      <td>${money(o.costos.total)}</td>
      <td>${money(o.costos.pagado||0)}</td>
      <td>${money(saldo(o))}</td>
      <td><button class="btn light sm" data-act="detalle" data-id="${o.id}">Ver detalle</button></td>
    `;
    body.appendChild(tr);
  };

  if(mode==="Predeterminado"){
    days.forEach(d=>{
      const gh=document.createElement("tr"); gh.className="grouprow";
      gh.innerHTML=`<td colspan="8">Fecha: ${d.split("-").reverse().join("/")} · Ventas del día: ${byDay[d].length}</td>`;
      body.appendChild(gh);
      byDay[d].sort((a,b)=>new Date(b.estado.ts_envio)-new Date(a.estado.ts_envio)).forEach(pushOrderRow);
    });
  }else{
    orders.sort((a,b)=>new Date(b.estado.ts_envio)-new Date(a.estado.ts_envio)).forEach(pushOrderRow);
  }
}

function renderStats(){
  const mode=$("statsRange")?.value||"Predeterminado";
  const pagos=load(KEY_PAGOS,[]); const orders=load(KEY_ORDERS,[]); const byId=new Map(orders.map(o=>[o.id,o]));
  const fil=pagos.filter(p=>inRange(p.ts,mode));
  const body=$("tbl-stats").querySelector("tbody"); body.innerHTML="";
  if(!fil.length){body.innerHTML=`<tr><td colspan="12" class="muted">Sin movimientos en el rango seleccionado.</td></tr>`;
    $("statsTotals").textContent="—"; $("statsFoot").innerHTML="<b>Total movimientos: Gs. 0</b>"; return;}
  let sum=0, sumMet={};
  const byDay={}; fil.forEach(p=>{const d=ymd(new Date(p.ts)); (byDay[d]=byDay[d]||[]).push(p);});

  const addPagoRow=(p)=>{
    const o=byId.get(p.pedido_id)||{};
    const diff=o.costos?((o.costos.total||0)-(o.costos.senia_inicial||0)):0;
    const s= o.id? Math.max(0,(o.costos.total+(o.costos.extra_corte||0)+(o.costos.extra_bordado||0)+(o.costos.extra_confeccion||0))-(o.costos.pagado||0)) : 0;
    sum+=Number(p.monto)||0; sumMet[p.metodo]=(sumMet[p.metodo]||0)+(Number(p.monto)||0);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${dateShort(p.ts)}</td>
      <td>${p.pedido_id}</td>
      <td>${p.cliente||"—"}</td>
      <td>${p.tel||"—"}</td>
      <td>${p.metodo||"—"}</td>
      <td>${p.concepto||"—"}</td>
      <td>${money(p.monto)}</td>
      <td>${o.costos?money(o.costos.senia_inicial||0):"—"}</td>
      <td>${o.costos?money(o.costos.total||0):"—"}</td>
      <td>${o.costos?money(diff):"—"}</td>
      <td>${o.id?(s>0?`<span class="fee red">${money(s)}</span>`:`<span class="fee green">${money(0)}</span>`):"—"}</td>
      <td>${o.id?(s===0?"Sí":"No"):"—"}</td>
    `;
    body.appendChild(tr);
  };

  if(mode==="Predeterminado"){
    Object.keys(byDay).sort().reverse().forEach(d=>{
      const gh=document.createElement("tr"); gh.className="grouprow";
      gh.innerHTML=`<td colspan="12">Fecha: ${d.split("-").reverse().join("/")}</td>`;
      body.appendChild(gh);
      byDay[d].sort((a,b)=>new Date(b.ts)-new Date(a.ts)).forEach(addPagoRow);
    });
  }else{
    fil.sort((a,b)=>new Date(b.ts)-new Date(a.ts)).forEach(addPagoRow);
  }
  const totalChips=Object.keys(sumMet).sort().map(k=>`<span class="badge"><b>${k}:</b> ${money(sumMet[k])}</span>`).join(" ");
  $("statsTotals").innerHTML = totalChips || "—";
  $("statsFoot").innerHTML = `<b>Total movimientos: ${money(sum)}</b>`;
}

/* Descargar PDF */
$("btnStatsPDF").addEventListener("click",()=>{
  const mode=$("statsRange").value;
  const title=`Estadísticas de pagos – ${mode}`;
  const table=$("tbl-stats").outerHTML;
  const totals=$("statsTotals").outerHTML;
  const foot=$("statsFoot").outerHTML;
  const win=window.open("","_blank");
  const styles=`<style>
      body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;padding:24px}
      h1{margin:0 0 12px 0;font-size:20px}
      .muted{color:#6b7280}
      table{width:100%;border-collapse:separate;border-spacing:0}
      thead th{background:#f4c3d4;text-align:left;font-size:12px;border-bottom:1px solid #e5e7eb;padding:8px}
      tbody td{border-bottom:1px solid #e5e7eb;padding:6px 8px;font-size:12px}
      tr:nth-child(even) td{background:#ffe3ef}
      .badge{display:inline-block;border:1px solid #e5e7eb;border-radius:999px;padding:4px 8px;margin-right:6px}
    </style>`;
  win.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>${title}</title>${styles}</head><body>
    <h1>${title}</h1>
    <div>${totals}</div>
    ${table}
    <div style="margin-top:12px">${foot}</div>
    <script>window.onload=()=>window.print();<\/script>
  </body></html>`);
  win.document.close();
});

/* ===== Detalle / Editar / Eliminar (solo admin) ===== */
let detailCurrentId=null;
function openDetalle(o){
  detailCurrentId=o.id;
  const s=saldo(o);
  $("md_title").textContent=`Pedido #${o.id} – ${o.cliente.nombre}`;
  $("md_body").innerHTML=`
    <div class="summary">
      <div><b>Fecha:</b> ${dateShort(o.ts)}</div>
      <div><b>Cargado por:</b> ${o.creado_por||"—"}</div>
      <div><b>Tel:</b> ${o.cliente.tel} · <b>Email:</b> ${o.cliente.email||"—"}</div>
      <div><b>RS/RUC:</b> ${o.cliente.razon_social||"—"} / ${o.cliente.ruc||"—"}</div>
      <hr style="border:none;border-top:1px solid var(--border);margin:10px 0">
      <div><b>Tela/Color:</b> ${o.especificaciones.tela} / ${o.especificaciones.color}</div>
      <div><b>Modelo:</b> ${o.especificaciones.modelo}</div>
      <div><b>Chomba:</b> ${o.especificaciones.chomba||"—"} · <b>Pantalón:</b> ${o.especificaciones.pantalon||"—"}</div>
      <div><b>Bord. nombre:</b> ${yesno(o.bordados.nombre)} ${o.bordados.nombre_texto?("("+o.bordados.nombre_texto+")"):""}</div>
      <div><b>Letra y color:</b> ${o.bordados.letra_color||"—"}</div>
      <div><b>Bord. logo:</b> ${yesno(o.bordados.logo)}</div>
      <div><b>Notas:</b> ${o.especificaciones.notas||"—"}</div>
      <hr style="border:none;border-top:1px solid var(--border);margin:10px 0">
      <div><b>Total:</b> ${money(o.costos.total)} · <b>Pagado:</b> ${money(o.costos.pagado||0)} · <b>Saldo:</b> ${s>0?`<span class="fee red">${money(s)}</span>`:`<span class="fee green">${money(0)}</span>`}</div>
      <div><b>Etapa:</b> ${o.estado.etapa}</div>
      <div><b>Entrega:</b> ${o.entrega.tipo} ${o.entrega.tipo==="Delivery"?"· "+(o.entrega.gps||"—"):""} ${o.entrega.tipo==="Encomienda"?"· "+(o.entrega.ciudad||"—")+" · "+(o.entrega.direccion||"—"):""}</div>
    </div>`;
  $("md_delete").style.display = (currentRole()==="admin") ? "inline-block" : "none";
  $("modalDetalle").showModal();
}
$("md_close").onclick=()=>$("modalDetalle").close();
$("md_ok").onclick=()=>$("modalDetalle").close();
$("md_edit").onclick=()=>{
  const arr=load(KEY_ORDERS,[]); const o=arr.find(x=>x.id===detailCurrentId); if(!o)return;
  editingOrderId=o.id;
  $("tituloNP").textContent=`Editar Pedido #${o.id}`;
  $("np_nombre").value=o.cliente.nombre||"";
  $("np_tel").value=o.cliente.tel||"";
  $("np_email").value=o.cliente.email||"";
  $("np_rs").value=o.cliente.razon_social||"";
  $("np_ruc").value=o.cliente.ruc||"";
  $("np_genero").value=o.cliente.genero||"";
  $("np_tela").value=o.especificaciones.tela||"";
  $("np_color").value=o.especificaciones.color||"";
  $("np_modelo").value=o.especificaciones.modelo||"";
  $("np_chomba").value=o.especificaciones.chomba||"";
  $("np_pantalon").value=o.especificaciones.pantalon||"";
  $("np_notas").value=o.especificaciones.notas||"";
  $("np_b_nombre").value=o.bordados.nombre?"Sí":"No";
  $("np_nombre_bordar").value=o.bordados.nombre_texto||"";
  $("np_letra_color").value=o.bordados.letra_color||"";
  $("np_b_logo").value=o.bordados.logo?"Sí":"No";
  $("np_use_desc").checked=(o.costos.descuento_pct||0)>0;
  $("np_desc_pct").value=o.costos.descuento_pct||0;
  $("np_senia").value=formatPY(String(o.costos.senia_inicial||0));
  $("np_pago").value="Efectivo";
  $("np_entrega").value=o.entrega.tipo||"Retiro en local";
  $("np_delivery_gps").value=o.entrega.gps||"";
  $("np_envio_ciudad").value=o.entrega.ciudad||"";
  $("np_envio_dir").value=o.entrega.direccion||"";
  toggle($("grp_nombre_bordar"),o.bordados.nombre===true);
  toggle($("grp_letra_color"),o.bordados.nombre===true);
  toggle($("grp_logo_file"),o.bordados.logo===true);
  toggle($("grp_desc"),$("np_use_desc").checked);
  const v=$("np_entrega").value; toggle($("grp_delivery"),v==="Delivery");const isEnv=v==="Encomienda";toggle($("grp_envio_city"),isEnv);toggle($("grp_envio_addr"),isEnv);
  recalc(); $("modalDetalle").close(); modal.showModal();
};
// eliminar (solo admin)
$("md_delete").onclick=()=>{
  if(currentRole()!=="admin") return;
  const ok=confirm("¿Eliminar este pedido? Esta acción no se puede deshacer.");
  if(!ok) return;
  const arr=load(KEY_ORDERS,[]).filter(x=>x.id!==detailCurrentId);
  save(KEY_ORDERS,arr);
  $("modalDetalle").close();
  renderAll();
};

/* ===== Clicks globales ===== */
document.body.addEventListener("click",(e)=>{
  const b=e.target.closest("button[data-act]"); if(!b) return;
  const id=Number(b.dataset.id), act=b.dataset.act;
  const orders=load(KEY_ORDERS,[]), sales=load(KEY_SALES,[]);
  const o=orders.find(x=>x.id===id);
  if(act==="gotoPedido"){ gotoPedidoAndHighlight(id); return; }
  if(act==="enviar" && o){
    const s=saldo(o);
    if(s>0 && !o.entrega.pago_al_recibir){
      const ok=confirm("Este pedido tiene saldo pendiente de "+money(s)+". ¿Marcar como Enviado igualmente?");
      if(!ok) return;
    }
    o.estado.enviado=true; o.estado.etapa="Ventas"; o.estado.ts_envio=new Date().toISOString();
    sales.push({ts:o.estado.ts_envio,tipo:"enviado",pedido_id:o.id,codigo:o.codigo,total:o.costos.total,creado_por:o.creado_por||"—"});
  }
  if(act==="paySaldo" && o){
    const s=saldo(o);
    if(s<=0){ alert("Este pedido no tiene saldo pendiente."); return; }
    const row=b.closest("tr"); const sel=row?row.querySelector('select[data-act="metodo"]'):null; const metodo=sel?.value||"Efectivo";
    o.costos.pagado=(o.costos.pagado||0)+s;
    logPago({ts:new Date().toISOString(),pedido_id:o.id,cliente:o.cliente.nombre,tel:o.cliente.tel,metodo,concepto:"Saldo",monto:s});
  }
  if(act==="detalle" && o){ openDetalle(o); }
  if(act==="p-detalle" && o){ openDetalle(o); }
  save(KEY_ORDERS,orders); save(KEY_SALES,sales); renderAll();
});

/* ===== Modales ÍTEM / VENTA ===== */
const modalItem=$("modalItem");
$("btnNuevoItem").onclick=()=>requireLogin(()=>{
  $("formItem").reset(); $("mi_price").textContent="Precio prenda: Gs. 0"; modalItem.showModal();
});
$("mi_close").onclick=()=>modalItem.close(); $("mi_cancel").onclick=()=>modalItem.close();
["mi_tela"].forEach(id=>$(id).addEventListener("input",()=>{$("mi_price").textContent="Precio prenda: "+money(precioPrenda($("mi_tela").value));}));
$("mi_save").onclick=()=>{
  const it={
    genero:$("mi_genero").value,categoria:$("mi_cat").value,tela:$("mi_tela").value,
    color:sanitize($("mi_color").value),talle:$("mi_talle").value,stock:Number($("mi_stock").value||0),
    desc:sanitize($("mi_desc").value||"")
  };
  if(!it.genero||!it.categoria||!it.tela||!it.color||!it.talle||!it.stock){alert("Completá los campos requeridos.");return;}
  invUpsert(it);
  invLogPush({ts:new Date().toISOString(),user:currentUser()||"—",action:"alta",detail:`${it.genero} · ${it.categoria} · ${it.tela} · ${it.color} · ${it.talle} — Stock: ${it.stock}`});
  modalItem.close(); renderInventario(); renderInvLog();
};

const modalVenta=$("modalVenta");
let ventaItemsCache=[];
$("btnNuevaVenta").onclick=()=>requireLogin(()=>{ $("formVenta").reset(); toggle($("mv_fact_grp"),false); toggle($("mv_grp_desc"),false); refreshVentaItems(); recalcVenta(); modalVenta.showModal(); });
$("mv_close").onclick=()=>modalVenta.close(); $("mv_cancel").onclick=()=>modalVenta.close();
$("mv_fact").addEventListener("change",()=>toggle($("mv_fact_grp"),$("mv_fact").checked));
$("mv_use_desc").addEventListener("change",()=>toggle($("mv_grp_desc"),$("mv_use_desc").checked));
$("mv_entrega").addEventListener("input",()=>{const v=$("mv_entrega").value;toggle($("mv_grp_delivery"),v==="Delivery");const isEnv=v==="Encomienda";toggle($("mv_grp_envio_city"),isEnv);toggle($("mv_grp_envio_addr"),isEnv);});
["mv_item1","mv_item2","mv_q1","mv_q2","mv_desc_pct","mv_use_desc"].forEach(id=>$(id).addEventListener("input",recalcVenta));
["mv_search1","mv_search2"].forEach(id=>$(id).addEventListener("input",()=>{ renderVentaOptions($("mv_item1"),$("mv_search1").value||"", true); renderVentaOptions($("mv_item2"),$("mv_search2").value||"", false); recalcVenta(); }));

function refreshVentaItems(){ const inv=invGetAll().filter(x=>Number(x.stock)>0); ventaItemsCache=inv.slice();
  renderVentaOptions($("mv_item1"), $("mv_search1").value||"", true);
  renderVentaOptions($("mv_item2"), $("mv_search2").value||"", false);
}
function renderVentaOptions(sel, q, isFirst){
  const prev=sel.value; const norm=t=>t.toString().toLowerCase();
  const list=ventaItemsCache.filter(x=>{const str=[x.genero,x.categoria,x.tela,x.color,x.talle].join(" ").toLowerCase(); return !q || str.includes(norm(q));});
  const opt = (x)=>`<option value="${x.id}" data-precio="${x.precio}">${x.genero} · ${x.categoria} · ${x.tela} · ${x.color} · ${x.talle} — Stock:${x.stock} — ${money(x.precio)}</option>`;
  sel.innerHTML = `<option value="">${isFirst?"(Seleccionar)":"(Ninguno)"}</option>` + list.map(opt).join("");
  if(prev && list.find(x=>x.id===prev)){ sel.value=prev; }
}
function recalcVenta(){
  const inv=invGetAll(); const byId=new Map(inv.map(x=>[x.id,x]));
  const id1=$("mv_item1").value, id2=$("mv_item2").value;
  const q1=Math.max(0,Number($("mv_q1").value||0)), q2=Math.max(0,Number($("mv_q2").value||0));
  const p1=id1? (byId.get(id1)?.precio||0)*q1 : 0; const p2=id2? (byId.get(id2)?.precio||0)*q2 : 0;
  const sub=p1+p2; const useD=$("mv_use_desc").checked; const dPct=Math.min(100,Math.max(0,Number($("mv_desc_pct").value||0)));
  const total=useD?Math.round(sub*(1-dPct/100)):sub; $("mv_totalChip").textContent="Total: "+money(total); return total;
}
$("mv_confirm").onclick=()=>{
  const total=recalcVenta();
  const id1=$("mv_item1").value, id2=$("mv_item2").value;
  const q1=Math.max(0,Number($("mv_q1").value||0)), q2=Math.max(0,Number($("mv_q2").value||0));
  if(!id1||q1<=0){alert("Seleccioná al menos un ítem con cantidad.");return;}
  const metodo=$("mv_pago").value||""; if(!metodo){alert("Elegí un método de pago.");return;}
  const inv=invGetAll(); const byId=new Map(inv.map(x=>[x.id,x]));
  if(q1>(byId.get(id1)?.stock||0)) {alert("Stock insuficiente para ítem 1.");return;}
  if(id2 && q2>(byId.get(id2)?.stock||0)) {alert("Stock insuficiente para ítem 2.");return;}
  byId.get(id1).stock -= q1; if(id2) byId.get(id2).stock -= q2; invSaveAll(Array.from(byId.values()));
  const orders=load(KEY_ORDERS,[]), sales=load(KEY_SALES,[]); const id=nextId();
  const telDigits=onlyDigits($("mv_tel").value), codigo=telDigits.slice(-3).padStart(3,"0");
  const now=new Date().toISOString(); const entrega=$("mv_entrega").value;
  const order={
    id, ts:now, codigo, creado_por: currentUser()||"—",
    cliente:{nombre:sanitize($("mv_nombre").value),tel:sanitize($("mv_tel").value),email:sanitize($("mv_email").value),razon_social:$("mv_fact").checked?sanitize($("mv_rs").value):"",ruc:$("mv_fact").checked?sanitize($("mv_ruc").value):"",genero:""},
    especificaciones:{tela:"—",color:"—",modelo:"—",chomba:"",pantalon:"",notas:`Venta directa: ${id1}${id2?(", "+id2):""}`},
    bordados:{nombre:false,nombre_texto:"",logo:false,logo_filename:"",logo_data:"",letra_color:"",otras_especificaciones_bordado:""},
    entrega:{tipo:entrega,gps:sanitize($("mv_delivery_gps").value),ciudad:sanitize($("mv_envio_ciudad").value),direccion:sanitize($("mv_envio_dir").value),encomienda_pagada:false,pago_al_recibir:false},
    costos:{regla:PRICE_TABLE,extra_nombre:0,extra_logo:0,subtotal:total,descuento_pct:0,subtotal_desc:total,total:total,pagado:total,senia_inicial:0,extra_corte:0,extra_corte_pagado:false,extra_bordado:0,extra_bordado_pagado:false,extra_confeccion:0,extra_confeccion_pagado:false},
    estado:{etapa:"Ventas",recibido:false,bordado_recibido:false,confeccion_ok:false,listo:true,enviado:true,ts_envio:now}
  };
  orders.push(order); save(KEY_ORDERS,orders);
  sales.push({ts:now,tipo:"venta_directa",pedido_id:id,codigo:order.codigo,total:total,creado_por:order.creado_por}); save(KEY_SALES,sales);
  logPago({ts:now,pedido_id:id,cliente:order.cliente.nombre,tel:order.cliente.tel,metodo:metodo,concepto:"Venta",monto:total});
  alert("✅ Venta registrada.");
  modalVenta.close(); renderAll(); renderInventario();
};

/* ===== Config: usuarios & inv log ===== */
function renderUsers(){
  const body=$("tbl-users").querySelector("tbody"); body.innerHTML="";
  const me=currentUser(); const users=getUsers();
  users.forEach((u,idx)=>{
    const tr=document.createElement("tr");
    const canDelete = !(u.user===me) && !(u.role==="admin" && users.filter(x=>x.role==="admin").length<=1);
    tr.innerHTML=`<td>${u.user}</td><td>${u.role==="admin"?"Administrador":"Usuario"}</td>
      <td>${canDelete?`<button class="btn light sm" data-udel="${idx}">Eliminar</button>`:"—"}</td>`;
    body.appendChild(tr);
  });
  body.querySelectorAll("button[data-udel]").forEach(btn=>{
    btn.onclick=()=>{const idx=Number(btn.dataset.udel); const users=getUsers();
      const who=users[idx]; if(!confirm(`Eliminar usuario "${who.user}"?`)) return;
      users.splice(idx,1); setUsers(users); renderUsers();
    };
  });
}
$("formUser").addEventListener("submit",(e)=>{
  e.preventDefault();
  const user=sanitize($("cu_user").value), pass=$("cu_pass").value, role=$("cu_role").value;
  if(!user||!pass||!role){alert("Completá todos los campos.");return;}
  const users=getUsers(); if(users.find(u=>u.user.toLowerCase()===user.toLowerCase())){alert("Ese usuario ya existe.");return;}
  users.push({user,pass,role}); setUsers(users); $("formUser").reset(); renderUsers(); alert("✅ Usuario creado.");
});
$("invLogRange").addEventListener("input",renderInvLog);

/* ===== Login local ===== */
function showLogin(){ const dlg=$("modalLogin"); $("lg_user").value=""; $("lg_pass").value=""; dlg.showModal(); setTimeout(()=>$("lg_user").focus(), 50); }
function doLogin(){
  const u=sanitize($("lg_user").value); const p=$("lg_pass").value; const keep=$("lg_keep").checked;
  const users=getUsers();
  const found=users.find(x=>x.user.toLowerCase()===u.toLowerCase() && x.pass===p);
  if(found){
    const ttl= keep ? (24*60*60*1000) : (60*60*1000);
    setAuth({user:found.user,role:found.role,ts:Date.now(),exp:Date.now()+ttl});
    $("modalLogin").close(); applyRoleUI(); renderAll(); loadAvatar();
    if(postLoginAction){ const fn=postLoginAction; postLoginAction=null; fn(); }
  }else{
    alert("Usuario o contraseña incorrectos.");
  }
}
$("btnLogout")?.addEventListener("click", ()=>{ setAuth(null); showLogin(); });
$("lg_submit").addEventListener("click", doLogin);
$("lg_cancel").addEventListener("click", ()=>$("modalLogin").close());
$("formLogin").addEventListener("submit",(e)=>{e.preventDefault();doLogin();});

/* ===== Init & Render ===== */
function renderAll(){
  applyRoleUI();
  renderPedidos(); renderInventario(); renderCorte(); renderBordado(); renderConf(); renderListos(); renderFalta(); renderVentas(); renderStats();
  if(document.querySelector(".tab#tab-config.active")){ renderUsers(); renderInvLog(); }
}
ensureUsers();
renderAll();
loadAvatar();
if(!isSessionValid()){ showLogin(); }

/* ===== Hooks ===== */
["corteFilter","corteGender","bordadoFilter","confFilter","ventasRange","statsRange"].forEach(id=>{const el=$(id);if(el)el.addEventListener("input",renderAll);});
$("searchBox").addEventListener("input",renderAll);
</script>
</body>
</script>
</html>
